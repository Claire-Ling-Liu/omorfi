#!/bin/bash
# coverage for jrc acquis
fsa="@top_builddir@/src/generated/omorfi-omor.analyse.hfst"
if ! test -r $fsa ; then
    echo Unable to find built fsa for tests: $fsa
fi

function _preproc() {
    cat $@ | sed -e 's/[[:punct:]][[:space:][:punct:]]/ \0/g' \
        -e 's/[[:punct:]]\r\?$/ \0/' -e 's/^[[:punct:]]/\0 /' \
        -e 's/[[:space:]][[:punct:]]/\0 /g' -e 's/[[:space:]]/ /g' |\
        tr -s ' ' '\n'
}
preprocess=_preproc
if ! test -f "jrc-fi.tokens" ; then
    if ! test -f "jrc-fi.tgz" ; then
        fetch-jrc-acquis.bash "fi"
    fi
    unpack-jrc-acquis.bash "fi" > "jrc-fi.text"
    $preprocess < "jrc-fi.text" > "jrc-fi.tokens"
fi
echo Looking up jrc-fi.tokens
@TIME@ -o "jrc-fi.times" -a hfst-optimised-lookup -q $fsa < "jrc-fi.tokens" > "jrc-fi.anals"
tokens=$(wc -l < jrc-fi.tokens)
misses=$(fgrep -c '+?' < jrc-fi.anals)
coverage=$(echo "100 - 100 * $misses/$tokens" | bc )

if test $coverage -lt 93 ; then
    echo JRC acquis coverage should be more than 93, see:
    fgrep '+?' < "jrc-fi.anals" | sort | uniq -c | sort -nr | head 
    exit 1
fi


