#!/bin/bash
# coverage for europarl
fsa="@top_builddir@/src/morphology.@TAGSET@.hfst"
if ! test -r @top_builddir@/src/morphology.@TAGSET@.hfst ; then
    echo Unable to find built fsa for tests: $fsa
fi

function _preproc() {
    cat $@ | sed -e 's/[[:punct:]][[:space:][:punct:]]/ \0/g' \
        -e 's/[[:punct:]]\r\?$/ \0/' -e 's/^[[:punct:]]/\0 /' \
        -e 's/[[:space:]][[:punct:]]/\0 /g' -e 's/[[:space:]]/ /g' |\
        tr -s ' ' '\n'
}
preprocess=_preproc
if ! test -f "europarl-v7.fi-en.fi.tokens" ; then
    if ! test -f "fi-en.tgz" ; then
        wget "http://www.statmt.org/europarl/v7/fi-en.tgz"
    fi
    tar zxvf "fi-en.tgz"
    rm "europarl-v7.fi-en.en"
    $preprocess < europarl-v7.fi-en.fi > europarl-v7.fi-en.fi.tokens
fi
hfst-lookup -q $fsa < europarl-v7.fi-en.fi.tokens > europarl-v7.fi-en.fi.anals
tokens=$(wc -l < europarl-v7.fi-en.fi.tokens)
misses=$(fgrep -c '+?' < europarl-v7.fi-en.fi.anals)
coverage=$(echo 100 * $misses/$tokens | bc )

if test $coverage -lt 95 ; then
    echo europarl coverage should be more than 95, see:
    fgrep '+?' < europarl-v7.fi-en.fi.anals | sort | uniq -c | sort -nr | head -n 1000
    exit 1
fi

