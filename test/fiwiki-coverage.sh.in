#!/bin/bash
# coverage for fiwiki-latest
fsa="@top_builddir@/src/generated/omorfi-omor.analyse.hfst"
if ! test -r $fsa ; then
    echo Unable to find built fsa for tests: $fsa
fi

function _preproc() {
    cat $@ | sed -e 's/[[:punct:]][[:space:][:punct:]]/ \0/g' \
        -e 's/[[:punct:]]\r\?$/ \0/' -e 's/^[[:punct:]]/\0 /' \
        -e 's/[[:space:]][[:punct:]]/\0 /g' -e 's/[[:space:]]/ /g' |\
        tr -s ' ' '\n'
}
preprocess=_preproc
if ! test -f "fiwiki-latest-pages-articles.uniq.freqs" ; then
    if ! test -f "fiwiki-latest-pages-articles.tokens" ; then
        if ! test -f "fiwiki-latest-pages-articles.xml.bz2" ; then
            fetch-wikimedia.bash fiwiki
        fi
        unpack-wikimedia.bash fiwiki > fiwiki-latest-pages-articles.text
        $preprocess < fiwiki-latest-pages-articles.text > fiwiki-latest-pages-articles.tokens
    fi
    sort < fiwiki-latest-pages-articles.tokens | uniq -c | sort -nr > fiwiki-latest-pages-articles.uniq.freqs
fi
echo Looking up fiwiki-latest-pages-articles.tokens
if ! @PYTHON@ $srcdir/coverage.py -f $fsa -i fiwiki-latest-pages-articles.uniq.freqs -c 2 -o fiwiki-coverage.log -t 91 ; then
    exit 1
fi


